<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Airplane Storage v1</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.15/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.15/"></script>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>

    <script>
      require([
        "esri/Map",
        "esri/Graphic",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/layers/GraphicsLayer",
        "esri/geometry/Point",
        "esri/symbols/PictureMarkerSymbol",
        "esri/symbols/TextSymbol",
        "esri/renderers/UniqueValueRenderer",
        "esri/renderers/visualVariables/RotationVariable",
        "esri/widgets/CoordinateConversion",        
        "esri/widgets/BasemapToggle",
        "esri/widgets/Measurement",
        "esri/widgets/Editor"
      ], function(Map, Graphic, MapView, FeatureLayer, GraphicsLayer, Point, PictureMarkerSymbol, TextSymbol, UniqueValueRenderer, RotationVariable, CoordinateConversion, BasemapToggle, Measurement, Editor) {
      
/// GLOBALS

        var scaleSizes = new Array(25);
        scaleSizes[16] = "40px";
        scaleSizes[17] = "80px";
        scaleSizes[18] = "160px";

/// MAP AND VIEW

        var map = new Map({
          basemap: "hybrid"
        });

        var mapView = new MapView({
          container: "viewDiv",
          map: map,
          zoom: 18,
          center: [-112.009, 33.433],
          navigation: {mouseWheelZoomEnabled: false}, 
          constraints: {maxZoom: 18, minZoom: 16}
        });

/// FUNCTIONS

        function drawZoomLevelLabel(){

          glyrMapLabels.removeAll();
          var tsym = new TextSymbol({
            text: mapView.zoom.toFixed().toString(), 
            color: 'red', 
            font: {size: 16, weight: 'bold'},
            haloColor: 'white',
            haloSize: '2px'
          });
          var pt = mapView.toMap(new Point({x: 30, y: 110}));
          var gr = new Graphic({geometry: pt, symbol: tsym});
          glyrMapLabels.add(gr);

        }

        function renderAircraft() {

          var mrk_size = scaleSizes[mapView.zoom];

          function makeAircraftSymbol(aircraftType) {
            var pms = new PictureMarkerSymbol({
              url: 'images/' + aircraftType + '.png',
              width: mrk_size,
              height: mrk_size
            });
            return pms;
          }

          // rotate aircraft markers using field value
          var rv = new RotationVariable({
            field: 'Rotation',
            rotationType: 'geographic'
          })

          // renderer for aircraft layer
          var uvr = new UniqueValueRenderer({
            field: 'Model',
            visualVariables: rv,
            uniqueValueInfos: [
              {value: '777 300',   symbol: makeAircraftSymbol('777 300')}, 
              {value: '747 400',   symbol: makeAircraftSymbol('747 400')}, 
              {value: '767 300',   symbol: makeAircraftSymbol('767 300')}, 
              {value: 'KC-135',    symbol: makeAircraftSymbol('KC-135')}, 
              {value: '737 800',   symbol: makeAircraftSymbol('737 800')}, 
              {value: '737 400',   symbol: makeAircraftSymbol('737 400')}, 
              {value: 'CRJ 700',   symbol: makeAircraftSymbol('CRJ 700')}, 
              {value: 'CRJ 200',   symbol: makeAircraftSymbol('CRJ 200')}, 
              {value: 'Dash 8 300',symbol: makeAircraftSymbol('Dash 8 300')}, 
              {value: 'MD 11',     symbol: makeAircraftSymbol('MD 11')}, 
              {value: 'MD 90',     symbol: makeAircraftSymbol('MD 90')}, 
              {value: '320',       symbol: makeAircraftSymbol('320')}, 
              {value: '321',       symbol: makeAircraftSymbol('321')}, 
              {value: '300 B',     symbol: makeAircraftSymbol('300 B')}
            ]
          });

          flAircraft.renderer = uvr;

        } // end of function: renderAircraft()

/// LAYERS

        var template = {
          title: 'Aircraft',
          content: [
            {
              type: "fields",
              fieldInfos: [
                {fieldName: "Aircraft_Type",      label: "Aircraft Type"},
                {fieldName: "Manufacturer",       label: "Manufacturer"},
                {fieldName: "Model",              label: "Model"},
                {fieldName: "Wingspan",           label: "Wingspan (ft)"},
                {fieldName: "Length",             label: "Length (ft)"},
                {fieldName: "Gross_Weight",       label: "Gross Weight"},
                {fieldName: "Carrier",            label: "Carrier"},
                {fieldName: "Date In",            label: "Date In"},
                {fieldName: "Date Out",           label: "Date Out"},
                {fieldName: "Rotation",           label: "Rotation"}
              ]
            }
          ]
        } // end template

        var flAircraft = new FeatureLayer({
          url: "https://services.arcgis.com/6I1ysurtNWNxkuwd/arcgis/rest/services/Aircraft_Storage/FeatureServer",
          popupTemplate: template
        });
        map.add(flAircraft);

        var glyrMapLabels = new GraphicsLayer();
        map.add(glyrMapLabels);

/// WIDGETS

        var toggleWidget = new BasemapToggle({
          view: mapView,
          nextBasemap: "gray"
        });
        var coordWidget = new CoordinateConversion({
          view: mapView
        });
        //var measureWidget = new Measurement({
        //  view: mapView,
        //  activeTool: "distance",
        //  linearUnit: "us-feet"
        //});
        mapView.ui.add(toggleWidget, "top-right");
        mapView.ui.add(coordWidget, "bottom-left");
        //mapView.ui.add(measureWidget, "bottom-right");
        
/// EVENTS

        mapView.when(function() {
          drawZoomLevelLabel();
          renderAircraft();
        });

        mapView.watch('zoom', function(){
          drawZoomLevelLabel();
          renderAircraft();
        })

      }); // END OF REQUIRE
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>
</html>
